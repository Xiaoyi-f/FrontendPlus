<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>响应式原理深入 - Vue.js快速上手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: #f8f9fa;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #42b983;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .breadcrumb {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .content {
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        h3 {
            color: #555;
            margin: 20px 0 12px;
        }
        
        p {
            margin-bottom: 15px;
            line-height: 1.8;
        }
        
        .code-block {
            background: #2d3648;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .code-comment {
            color: #637777;
        }
        
        .code-keyword {
            color: #c792ea;
        }
        
        .code-variable {
            color: #ffcb6b;
        }
        
        .code-string {
            color: #c3e88d;
        }
        
        .code-number {
            color: #f78c6c;
        }
        
        .code-function {
            color: #82aaff;
        }
        
        .code-boolean {
            color: #ff5874;
        }
        
        .reactivity-diagram {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .reactivity-step {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 5px;
            border: 1px solid #bbdefb;
        }
        
        .api-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .api-table th, .api-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .api-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .api-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .key-features {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
        }
        
        .key-features h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }
        
        .key-features ul {
            padding-left: 25px;
        }
        
        .key-features li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .comparison-item {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #42b983;
        }
        
        .comparison-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .practice {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
        }
        
        .practice h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .practice ul {
            padding-left: 25px;
        }
        
        .practice li {
            margin-bottom: 10px;
        }
        
        .vue-example {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .vue-example-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        nav {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .nav-link {
            display: inline-block;
            padding: 10px 20px;
            background: #42b983;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 0 10px;
        }
        
        .nav-link:hover {
            background: #359c6d;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="breadcrumb">Vue.js快速上手 > 进阶特性篇 > 响应式原理深入</div>
            <h1>响应式原理深入</h1>
        </header>
        
        <div class="content">
            <p>Vue.js的响应式系统是其核心特性之一，它使得当数据发生变化时，视图会自动更新。在Vue 3中，响应式系统得到了重写，使用了ES6的Proxy API来替代Vue 2中的Object.defineProperty方法，提供了更强大和高效的功能。</p>
            
            <div class="key-features">
                <h3>响应式系统核心概念</h3>
                <ul>
                    <li><strong>Proxy对象</strong>：拦截对象操作的新方式</li>
                    <li><strong>Reactive</strong>：创建深层响应式对象</li>
                    <li><strong>Ref</strong>：创建响应式原始值</li>
                    <li><strong>Effect</strong>：副作用函数</li>
                    <li><strong>依赖追踪</strong>：自动追踪数据依赖</li>
                    <li><strong>批量更新</strong>：优化更新性能</li>
                </ul>
            </div>
            
            <h2>Vue 3响应式系统工作原理</h2>
            <div class="reactivity-diagram">
                <div class="reactivity-step">数据访问</div>
                →
                <div class="reactivity-step">依赖收集</div>
                →
                <div class="reactivity-step">数据变更</div>
                →
                <div class="reactivity-step">触发更新</div>
            </div>
            
            <p>Vue 3的响应式系统基于ES6的Proxy对象实现，它能够拦截对目标对象的访问和修改操作。当访问响应式数据时，系统会自动收集依赖；当数据发生变更时，系统会通知所有依赖该数据的观察者进行更新。</p>
            
            <h2>响应式API详解</h2>
            <table class="api-table">
                <thead>
                    <tr>
                        <th>API</th>
                        <th>用途</th>
                        <th>特点</th>
                        <th>适用场景</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>reactive</td>
                        <td>创建深层响应式对象</td>
                        <td>直接操作对象属性，不需要.value</td>
                        <td>复杂对象数据</td>
                    </tr>
                    <tr>
                        <td>ref</td>
                        <td>创建响应式原始值</td>
                        <td>需要通过.value访问值</td>
                        <td>原始类型数据</td>
                    </tr>
                    <tr>
                        <td>shallowReactive</td>
                        <td>浅层响应式对象</td>
                        <td>仅第一层属性是响应式的</td>
                        <td>性能敏感场景</td>
                    </tr>
                    <tr>
                        <td>shallowRef</td>
                        <td>浅层响应式引用</td>
                        <td>仅.value本身是响应式的</td>
                        <td>大型对象/数组</td>
                    </tr>
                    <tr>
                        <td>toRef</td>
                        <td>为属性创建响应式引用</td>
                        <td>与原数据保持连接</td>
                        <td>解构对象时保持响应性</td>
                    </tr>
                    <tr>
                        <td>toRefs</td>
                        <td>将对象的所有属性转为ref</td>
                        <td>批量转换为ref</td>
                        <td>解构响应式对象</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="vue-example">
                <div class="vue-example-title">响应式API示例</div>
                <div class="code-block">
                    &lt;div id=<span class="code-string">"app"</span>&gt;<br>
                    &nbsp;&nbsp;&lt;reactivity-demo&gt;&lt;/reactivity-demo&gt;<br>
                    &lt;/div&gt;<br><br>
                    
                    &lt;script&gt;<br>
                    <span class="code-keyword">const</span> { createApp, reactive, ref, shallowReactive, toRef, toRefs } = Vue;<br><br>
                    
                    createApp({})<br>
                    &nbsp;&nbsp;.component(<span class="code-string">'reactivity-demo'</span>, {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;setup() {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// reactive: 创建深层响应式对象</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> state = reactive({<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user: {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: <span class="code-string">'John'</span>,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;age: <span class="code-number">30</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count: <span class="code-number">0</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// ref: 创建响应式原始值</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> message = ref(<span class="code-string">'Hello Vue!'</span>);<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// shallowReactive: 浅层响应式对象</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> shallowState = shallowReactive({<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: <span class="code-string">'Shallow'</span>,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inner: {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value: <span class="code-string">'Not reactive'</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// toRef: 为属性创建响应式引用</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> countRef = toRef(state, <span class="code-string">'count'</span>);<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// toRefs: 将对象所有属性转为ref</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> stateRefs = toRefs(state);<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// 方法</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> updateState = <span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.count++;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.user.name = <span class="code-string">`John <span class="code-variable">${state.count}</span>`</span>;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message.value = <span class="code-string">`Updated at: <span class="code-variable">${new Date().toLocaleTimeString()}</span>`</span>;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shallowState,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;countRef,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stateRefs,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateState<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;},<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;template: `<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h3&gt;响应式API演示&lt;/h3&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;计数: {{ state.count }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;用户名: {{ state.user.name }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;消息: {{ message }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;浅层响应式: {{ shallowState.name }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;通过countRef访问: {{ countRef }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button @click=<span class="code-string">"updateState"</span>&gt;更新状态&lt;/button&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button @click=<span class="code-string">"shallowState.inner.value = 'Changed!'"</span>&gt;修改浅层对象内部值&lt;/button&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;`<br>
                    &nbsp;&nbsp;})<br>
                    &nbsp;&nbsp;.mount(<span class="code-string">'#app'</span>);<br>
                    &lt;/script&gt;
                </div>
            </div>
            
            <h2>Proxy vs Object.defineProperty</h2>
            <p>Vue 3使用Proxy替代了Vue 2中的Object.defineProperty来实现响应式系统。以下是两者的主要区别：</p>
            
            <div class="comparison">
                <div class="comparison-item">
                    <div class="comparison-title">Object.defineProperty (Vue 2)</div>
                    <ul>
                        <li>只能拦截属性的读/写操作</li>
                        <li>无法监听数组索引变化</li>
                        <li>无法监听对象属性的新增/删除</li>
                        <li>需要递归遍历所有嵌套属性</li>
                        <li>性能开销大</li>
                    </ul>
                </div>
                
                <div class="comparison-item">
                    <div class="comparison-title">Proxy (Vue 3)</div>
                    <ul>
                        <li>能拦截整个对象的操作</li>
                        <li>可以监听数组变化</li>
                        <li>可以监听对象属性的新增/删除</li>
                        <li>懒代理：仅在访问时创建响应式</li>
                        <li>性能更好</li>
                    </ul>
                </div>
            </div>
            
            <div class="vue-example">
                <div class="vue-example-title">响应式原理示例 - 简化版实现</div>
                <div class="code-block">
                    <span class="code-comment">// 简化的响应式系统实现示例</span><br>
                    <span class="code-keyword">function</span> <span class="code-function">createReactive</span>(target) {<br>
                    &nbsp;&nbsp;<span class="code-comment">// 存储依赖的WeakMap</span><br>
                    &nbsp;&nbsp;<span class="code-keyword">const</span> depsMap = <span class="code-keyword">new</span> <span class="code-function">WeakMap();</span><br><br>
                    
                    &nbsp;&nbsp;<span class="code-keyword">const</span> proxy = <span class="code-keyword">new</span> <span class="code-function">Proxy(target, {</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;get(target, key, receiver) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(<span class="code-string">`访问属性: <span class="code-variable">${String(key)}</span>`</span>);<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// 获取依赖Map</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">let</span> deps = depsMap.get(target);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> (!deps) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deps = <span class="code-keyword">new</span> <span class="code-function">Map();</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depsMap.set(target, deps);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// 获取特定key的依赖Set</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">let</span> dep = deps.get(key);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> (!dep) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dep = <span class="code-keyword">new</span> <span class="code-function">Set();</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deps.set(key, dep);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// 如果有活动的副作用函数，添加依赖</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> (activeEffect) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dep.add(activeEffect);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activeEffect.deps.push(dep);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> Reflect.get(target, key, receiver);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;},<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;set(target, key, value, receiver) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(<span class="code-string">`设置属性: <span class="code-variable">${String(key)}</span> = <span class="code-variable">${value}</span>`</span>);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> result = Reflect.set(target, key, value, receiver);<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// 触发依赖更新</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> deps = depsMap.get(target);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> (deps) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> dep = deps.get(key);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> (dep) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dep.forEach(<span class="code-function">effect</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;effect();<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> result;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;<span class="code-keyword">return</span> proxy;<br>
                    }<br><br>
                    
                    <span class="code-comment">// 活跃的副作用函数</span><br>
                    <span class="code-keyword">let</span> activeEffect = <span class="code-boolean">null</span>;<br><br>
                    
                    <span class="code-comment">// 副作用函数注册器</span><br>
                    <span class="code-keyword">function</span> <span class="code-function">effect</span>(fn) {<br>
                    &nbsp;&nbsp;<span class="code-keyword">const</span> effectFn = <span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;cleanup(effectFn);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;activeEffect = effectFn;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;fn();<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;activeEffect = <span class="code-boolean">null</span>;<br>
                    &nbsp;&nbsp;};<br>
                    &nbsp;&nbsp;effectFn.deps = [];<br>
                    &nbsp;&nbsp;effectFn(); <span class="code-comment">// 立即执行</span><br>
                    }<br><br>
                    
                    <span class="code-comment">// 清理依赖</span><br>
                    <span class="code-keyword">function</span> <span class="code-function">cleanup</span>(effectFn) {<br>
                    &nbsp;&nbsp;effectFn.deps.forEach(<span class="code-function">dep</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;dep.delete(effectFn);<br>
                    &nbsp;&nbsp;});<br>
                    &nbsp;&nbsp;effectFn.deps.length = <span class="code-number">0</span>;<br>
                    }<br><br>
                    
                    <span class="code-comment">// 使用示例</span><br>
                    <span class="code-keyword">const</span> state = createReactive({ count: <span class="code-number">0</span> });<br><br>
                    
                    effect(<span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;console.log(<span class="code-string">'count changed:'</span>, state.count);<br>
                    });<br><br>
                    
                    state.count++; <span class="code-comment">// 触发副作用函数</span><br>
                    state.count++; <span class="code-comment">// 再次触发副作用函数</span>
                </div>
            </div>
            
            <h2>依赖追踪与批量更新</h2>
            <p>Vue的响应式系统通过依赖追踪实现精确更新。当访问响应式数据时，系统会自动收集依赖；当数据变化时，会通知所有依赖进行更新。Vue还实现了批量更新机制，将多个数据变更合并到一次更新中，以提高性能。</p>
            
            <div class="vue-example">
                <div class="vue-example-title">依赖追踪示例</div>
                <div class="code-block">
                    &lt;div id=<span class="code-string">"app"</span>&gt;<br>
                    &nbsp;&nbsp;&lt;dependency-demo&gt;&lt;/dependency-demo&gt;<br>
                    &lt;/div&gt;<br><br>
                    
                    &lt;script&gt;<br>
                    <span class="code-keyword">const</span> { createApp, reactive, computed, watch } = Vue;<br><br>
                    
                    createApp({})<br>
                    &nbsp;&nbsp;.component(<span class="code-string">'dependency-demo'</span>, {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;setup() {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> state = reactive({<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count: <span class="code-number">0</span>,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: <span class="code-string">'Vue'</span>,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;items: [<span class="code-string">'a'</span>, <span class="code-string">'b'</span>, <span class="code-string">'c'</span>]<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// 计算属性 - 会自动追踪依赖</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> doubled = computed(<span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(<span class="code-string">'计算doubled...'</span>);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> state.count * <span class="code-number">2</span>;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> message = computed(<span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(<span class="code-string">'计算message...'</span>);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> <span class="code-string">`<span class="code-variable">${state.name}</span>: <span class="code-variable">${state.count}</span>`</span>;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// 监听器 - 也会追踪依赖</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;watch(<span class="code-function">()</span> =&gt; state.count, <span class="code-function">(newVal, oldVal)</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(<span class="code-string">`count从 <span class="code-variable">${oldVal}</span> 变为 <span class="code-variable">${newVal}</span>`</span>);<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> updateCount = <span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.count++;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> batchUpdate = <span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.count++;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.count++;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.count++;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doubled,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateCount,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;batchUpdate<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;},<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;template: `<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h3&gt;依赖追踪演示&lt;/h3&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Count: {{ state.count }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Doubled: {{ doubled }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Message: {{ message }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button @click=<span class="code-string">"updateCount"</span>&gt;增加计数&lt;/button&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button @click=<span class="code-string">"batchUpdate"</span>&gt;批量更新&lt;/button&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;`<br>
                    &nbsp;&nbsp;})<br>
                    &nbsp;&nbsp;.mount(<span class="code-string">'#app'</span>);<br>
                    &lt;/script&gt;
                </div>
            </div>
            
            <h2>响应式系统最佳实践</h2>
            <p>在使用Vue的响应式系统时，有一些最佳实践可以帮助我们更好地利用其功能：</p>
            
            <div class="key-features">
                <h3>响应式系统最佳实践</h3>
                <ul>
                    <li><strong>合理选择API</strong>：根据数据类型选择reactive或ref</li>
                    <li><strong>避免直接替换对象</strong>：保持响应性连接</li>
                    <li><strong>使用shallow类型</strong>：在性能敏感场景中</li>
                    <li><strong>理解响应式断开</strong>：避免解构破坏响应性</li>
                    <li><strong>利用计算属性</strong>：缓存复杂计算结果</li>
                    <li><strong>注意数组操作</strong>：Vue 3可以完全响应数组变化</li>
                </ul>
            </div>
            
            <div class="vue-example">
                <div class="vue-example-title">响应式断开与保持示例</div>
                <div class="code-block">
                    &lt;div id=<span class="code-string">"app"</span>&gt;<br>
                    &nbsp;&nbsp;&lt;reactivity-patterns&gt;&lt;/reactivity-patterns&gt;<br>
                    &lt;/div&gt;<br><br>
                    
                    &lt;script&gt;<br>
                    <span class="code-keyword">const</span> { createApp, reactive, ref, toRefs } = Vue;<br><br>
                    
                    createApp({})<br>
                    &nbsp;&nbsp;.component(<span class="code-string">'reactivity-patterns'</span>, {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;setup() {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> state = reactive({<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count: <span class="code-number">0</span>,<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: <span class="code-string">'Vue'</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// ❌ 错误：解构会破坏响应性</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// const { count, name } = state; </span><br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// ✅ 正确：使用toRefs保持响应性</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> stateRefs = toRefs(state);<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// ✅ 正确：直接使用reactive对象</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> increment = <span class="code-function">()</span> =&gt; {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.count++;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br><br>
                    
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...stateRefs, <span class="code-comment">// 现在解构是安全的</span><br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;increment<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;},<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;template: `<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h3&gt;响应式模式&lt;/h3&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Count: {{ count }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Name: {{ name }}&lt;/p&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button @click=<span class="code-string">"increment"</span>&gt;增加计数&lt;/button&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;`<br>
                    &nbsp;&nbsp;})<br>
                    &nbsp;&nbsp;.mount(<span class="code-string">'#app'</span>);<br>
                    &lt;/script&gt;
                </div>
            </div>
            
            <h3>响应式系统常见问题</h3>
            <p>在使用响应式系统时，可能会遇到一些常见问题：</p>
            
            <ul>
                <li><strong>解构破坏响应性</strong>：使用toRefs来解决</li>
                <li><strong>替换根对象</strong>：会导致响应性断开</li>
                <li><strong>属性添加/删除</strong>：Vue 3中可以正常响应</li>
                <li><strong>数组索引赋值</strong>：Vue 3中可以正常响应</li>
                <li><strong>性能考虑</strong>：对于大型对象，考虑使用shallowReactive</li>
            </ul>
            
            <div class="practice">
                <h3>实践练习</h3>
                <ul>
                    <li>实现一个简化的响应式系统，理解其工作原理</li>
                    <li>创建一个响应式状态管理器</li>
                    <li>实现一个基于响应式的表单验证系统</li>
                    <li>使用computed实现复杂的数据转换逻辑</li>
                    <li>创建一个响应式的UI组件状态管理器</li>
                    <li>实现一个响应式的本地存储系统</li>
                </ul>
            </div>
        </div>
        
        <nav>
            <a href="composition-api.html" class="nav-link">← 上一课：组合式API</a>
            <a href="teleport.html" class="nav-link">下一课：Teleport组件 →</a>
        </nav>
        
        <footer>
            <p>Vue.js快速上手 - 从零到大神，成为前端大拿，胜任大厂专家职位</p>
        </footer>
    </div>
</body>
</html>